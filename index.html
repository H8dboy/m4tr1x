<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M4TR1X â€” UNFILTERED SIGNAL</title>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --green: #00ff41;
            --green-dim: #00aa2b;
            --green-dark: #002200;
            --green-glow: rgba(0,255,65,0.12);
            --black: #000;
            --surface: rgba(5,10,5,0.97);
            --red: #ff2222;
            --yellow: #ffcc00;
            --blue: #00aaff;
            --font-mono: 'Share Tech Mono', monospace;
            --font-display: 'Orbitron', monospace;
            --topbar: 52px;
            --tabs: 44px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html, body { height:100%; width:100%; background:var(--black); color:var(--green); font-family:var(--font-mono); overflow:hidden; }

        /* scanlines */
        body::before { content:''; position:fixed; inset:0; background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,255,65,0.012) 3px,rgba(0,255,65,0.012) 4px); pointer-events:none; z-index:9999; }

        /* â”€â”€ TOPBAR â”€â”€ */
        #topbar { position:fixed; top:0; left:0; right:0; z-index:200; height:var(--topbar); background:linear-gradient(to bottom,rgba(0,0,0,0.9),transparent); display:flex; align-items:center; justify-content:space-between; padding:0 16px; }
        .logo { font-family:var(--font-display); font-size:1.1em; font-weight:900; letter-spacing:4px; color:var(--green); text-shadow:0 0 15px var(--green); }
        #topbar-right { display:flex; align-items:center; gap:10px; }
        .top-btn { background:none; border:none; color:var(--green); font-size:1.2em; cursor:pointer; padding:6px; transition:0.2s; }
        .top-btn:hover { text-shadow:0 0 10px var(--green); }
        #user-avatar-top { width:32px; height:32px; border-radius:50%; border:1.5px solid var(--green); overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1em; background:rgba(0,255,65,0.05); }
        #user-avatar-top img { width:100%; height:100%; object-fit:cover; }

        /* â”€â”€ SECTION TABS â”€â”€ */
        #section-tabs { position:fixed; top:var(--topbar); left:0; right:0; z-index:199; height:var(--tabs); display:flex; align-items:center; justify-content:center; background:linear-gradient(to bottom,rgba(0,0,0,0.75),transparent); }
        .sec-tab { padding:8px 24px; font-family:var(--font-display); font-size:0.62em; font-weight:700; letter-spacing:3px; color:rgba(0,255,65,0.35); background:none; border:none; cursor:pointer; transition:0.25s; position:relative; text-transform:uppercase; }
        .sec-tab::after { content:''; position:absolute; bottom:0; left:50%; right:50%; height:2px; background:var(--green); transition:0.25s; box-shadow:0 0 8px var(--green); }
        .sec-tab.active { color:var(--green); text-shadow:0 0 10px var(--green); }
        .sec-tab.active::after { left:15%; right:15%; }
        .sec-tab.film-tab.active { color:var(--blue); text-shadow:0 0 10px var(--blue); }
        .sec-tab.film-tab.active::after { background:var(--blue); box-shadow:0 0 8px var(--blue); }
        .sec-tab.music-tab.active { color:var(--yellow); text-shadow:0 0 10px var(--yellow); }
        .sec-tab.music-tab.active::after { background:var(--yellow); box-shadow:0 0 8px var(--yellow); }

        /* â”€â”€ BANNERS â”€â”€ */
        .section-banner { position:fixed; top:calc(var(--topbar) + var(--tabs)); left:0; right:0; z-index:198; padding:6px 14px; display:none; align-items:center; gap:10px; font-size:0.58em; letter-spacing:2px; backdrop-filter:blur(8px); }
        .section-banner.show { display:flex; }
        #banner-film { background:rgba(0,10,20,0.85); border-bottom:1px solid rgba(0,170,255,0.3); color:var(--blue); }
        #banner-music { background:rgba(20,10,0,0.85); border-bottom:1px solid rgba(255,204,0,0.3); color:var(--yellow); }
        .banner-icon { font-size:1.5em; }
        .banner-text strong { display:block; font-family:var(--font-display); font-size:1.05em; margin-bottom:1px; }

        /* â”€â”€ FEED WRAP â”€â”€ */
        #feed-wrap { position:fixed; inset:0; }
        .section-feed { position:absolute; inset:0; overflow-y:scroll; scroll-snap-type:y mandatory; -webkit-overflow-scrolling:touch; display:none; scrollbar-width:none; }
        .section-feed::-webkit-scrollbar { display:none; }
        .section-feed.active { display:block; }

        /* â”€â”€ VIDEO SLIDE â”€â”€ */
        .video-slide { width:100%; height:100vh; scroll-snap-align:start; position:relative; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        .slide-video { width:100%; height:100%; object-fit:cover; display:block; }
        .slide-video.landscape { object-fit:contain; }
        .grad-top { position:absolute; top:0; left:0; right:0; height:180px; background:linear-gradient(to bottom,rgba(0,0,0,0.65),transparent); pointer-events:none; z-index:1; }
        .grad-bot { position:absolute; bottom:0; left:0; right:0; height:320px; background:linear-gradient(to top,rgba(0,0,0,0.88),transparent); pointer-events:none; z-index:1; }

        /* play flash */
        .play-flash { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:4em; opacity:0; transition:opacity 0.25s; pointer-events:none; z-index:5; }
        .play-flash.on { opacity:1; }

        /* video progress */
        .vid-prog { position:absolute; bottom:0; left:0; right:0; height:2px; background:rgba(255,255,255,0.15); z-index:6; }
        .vid-prog-fill { height:100%; background:var(--green); box-shadow:0 0 6px var(--green); width:0%; }

        /* â”€â”€ SLIDE INFO (bottom-left) â”€â”€ */
        .slide-info { position:absolute; bottom:75px; left:14px; max-width:calc(100% - 80px); z-index:4; }
        .slide-author { display:flex; align-items:center; gap:8px; margin-bottom:7px; cursor:pointer; }
        .slide-av { width:36px; height:36px; border-radius:50%; border:2px solid var(--green); overflow:hidden; flex-shrink:0; background:rgba(0,255,65,0.05); display:flex; align-items:center; justify-content:center; font-size:1em; }
        .slide-av img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .slide-name { font-family:var(--font-display); font-size:0.72em; color:#fff; text-shadow:0 1px 5px #000; }
        .slide-time { font-size:0.58em; color:rgba(255,255,255,0.5); margin-left:4px; }
        .slide-meta { font-family:var(--font-display); font-size:0.78em; color:#fff; margin-bottom:4px; text-shadow:0 1px 4px #000; }
        .slide-genre { font-size:0.75em; color:rgba(255,255,255,0.55); margin-left:6px; }
        .slide-caption { font-size:0.78em; color:rgba(255,255,255,0.88); line-height:1.5; text-shadow:0 1px 4px #000; margin-bottom:4px; }
        .slide-tags { font-size:0.68em; color:var(--green); }

        /* â”€â”€ SIDE ACTIONS (right) â”€â”€ */
        .slide-actions { position:absolute; right:12px; bottom:90px; display:flex; flex-direction:column; align-items:center; gap:18px; z-index:4; }
        .sact { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; }
        .sact-icon { width:46px; height:46px; border-radius:50%; background:rgba(0,0,0,0.45); border:1.5px solid rgba(255,255,255,0.25); display:flex; align-items:center; justify-content:center; font-size:1.25em; transition:0.2s; backdrop-filter:blur(4px); }
        .sact:hover .sact-icon { border-color:var(--green); box-shadow:0 0 14px rgba(0,255,65,0.4); transform:scale(1.08); }
        .sact.zap-act:hover .sact-icon { border-color:var(--yellow); box-shadow:0 0 14px rgba(255,204,0,0.4); }
        .sact-label { font-size:0.55em; color:rgba(255,255,255,0.7); letter-spacing:1px; }

        /* â”€â”€ MUTE BTN â”€â”€ */
        #mute-btn { position:fixed; top:calc(var(--topbar)+var(--tabs)+28px); right:14px; z-index:198; background:rgba(0,0,0,0.55); border:1px solid rgba(255,255,255,0.2); color:#fff; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; backdrop-filter:blur(4px); font-size:0.9em; transition:0.2s; }
        #mute-btn:hover { border-color:var(--green); }

        /* â”€â”€ BOTTOM NAV â”€â”€ */
        #bottom-nav { position:fixed; bottom:0; left:0; right:0; z-index:200; height:60px; background:linear-gradient(to top,rgba(0,0,0,0.92),transparent); display:flex; align-items:center; justify-content:space-around; padding:0 6px; }
        .bnav { display:flex; flex-direction:column; align-items:center; gap:2px; background:none; border:none; color:rgba(255,255,255,0.45); font-family:var(--font-mono); font-size:0.52em; letter-spacing:1px; cursor:pointer; transition:0.2s; padding:8px 8px; }
        .bnav .bicon { font-size:1.5em; }
        .bnav.active, .bnav:hover { color:var(--green); }
        .bnav.film-nav.active { color:var(--blue); }
        .bnav.music-nav.active { color:var(--yellow); }
        .bnav.post-nav .bicon { background:var(--green); color:var(--black); width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:1.3em; box-shadow:0 0 14px rgba(0,255,65,0.4); }
        .bnav.post-nav { color:var(--green); }

        /* â”€â”€ COMMENTS DRAWER â”€â”€ */
        #comments-drawer { position:fixed; bottom:0; left:0; right:0; z-index:300; background:rgba(4,9,4,0.97); border-top:1px solid var(--green-dim); transform:translateY(100%); transition:transform 0.32s cubic-bezier(0.4,0,0.2,1); max-height:65vh; display:flex; flex-direction:column; backdrop-filter:blur(12px); }
        #comments-drawer.open { transform:translateY(0); }
        .drawer-bar { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--green-dark); cursor:pointer; }
        .drawer-bar-title { font-family:var(--font-display); font-size:0.68em; letter-spacing:2px; }
        .drawer-bar-close { background:none; border:none; color:var(--green-dim); font-size:1.1em; cursor:pointer; }
        #cmt-list { flex:1; overflow-y:auto; padding:8px 14px; }
        .cmt-item { padding:7px 0; border-bottom:1px solid var(--green-dark); font-size:0.74em; line-height:1.5; }
        .cmt-item:last-child { border:none; }
        .cmt-author { color:var(--green); font-family:var(--font-display); font-size:0.78em; margin-right:6px; }
        #cmt-input-bar { display:flex; padding:10px 14px; border-top:1px solid var(--green-dark); gap:0; }
        #cmt-input { flex:1; background:rgba(0,0,0,0.8); border:1px solid var(--green-dark); border-right:none; color:var(--green); font-family:var(--font-mono); font-size:0.78em; padding:10px 11px; outline:none; }
        #cmt-input:focus { border-color:var(--green-dim); }
        #cmt-send { background:var(--green); color:var(--black); border:none; font-family:var(--font-display); font-size:0.62em; font-weight:700; padding:0 14px; cursor:pointer; letter-spacing:1px; }

        /* â”€â”€ UPLOAD MODAL â”€â”€ */
        #upload-modal { position:fixed; inset:0; z-index:400; background:rgba(0,0,0,0.93); display:none; align-items:flex-end; }
        #upload-modal.open { display:flex; }
        .upload-sheet { width:100%; background:var(--surface); border-top:1px solid var(--green-dim); max-height:93vh; overflow-y:auto; animation:slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .up-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--green-dark); position:sticky; top:0; background:var(--surface); z-index:1; }
        .up-title { font-family:var(--font-display); font-size:0.72em; letter-spacing:2px; }
        .up-close { background:none; border:none; color:var(--green-dim); font-size:1.3em; cursor:pointer; }
        .up-cats { display:flex; gap:8px; padding:14px 16px 0; }
        .up-cat { flex:1; padding:10px 4px; text-align:center; font-family:var(--font-display); font-size:0.58em; letter-spacing:2px; cursor:pointer; transition:0.2s; border:1px solid; background:none; }
        .up-cat.signal { border-color:var(--green-dark); color:rgba(0,255,65,0.4); }
        .up-cat.film   { border-color:rgba(0,170,255,0.2); color:rgba(0,170,255,0.4); }
        .up-cat.music  { border-color:rgba(255,204,0,0.2); color:rgba(255,204,0,0.4); }
        .up-cat.signal.sel { border-color:var(--green); color:var(--green); background:var(--green-glow); }
        .up-cat.film.sel   { border-color:var(--blue); color:var(--blue); background:rgba(0,170,255,0.08); }
        .up-cat.music.sel  { border-color:var(--yellow); color:var(--yellow); background:rgba(255,204,0,0.08); }
        .up-body { padding:14px 16px; }
        .up-disc { display:none; padding:10px 12px; font-size:0.63em; line-height:1.7; margin-bottom:12px; border:1px solid; }
        .up-disc.film { border-color:rgba(0,170,255,0.25); color:var(--blue); background:rgba(0,170,255,0.04); }
        .up-disc.music { border-color:rgba(255,204,0,0.25); color:var(--yellow); background:rgba(255,204,0,0.04); }
        .drop-zone { border:2px dashed var(--green-dark); padding:28px 16px; text-align:center; cursor:pointer; transition:0.2s; margin-bottom:12px; }
        .drop-zone:hover,.drop-zone.drag { border-color:var(--green); background:var(--green-glow); }
        .dz-icon { font-size:2em; margin-bottom:6px; }
        .drop-zone p { font-size:0.72em; color:var(--green-dim); }
        #file-input { display:none; }
        .prev-wrap { display:none; margin-bottom:12px; }
        .prev-wrap video { width:100%; max-height:180px; border:1px solid var(--green-dark); }
        .field { margin-bottom:11px; }
        .field label { display:block; font-size:0.6em; color:var(--green-dim); letter-spacing:2px; margin-bottom:4px; text-transform:uppercase; }
        .field input,.field textarea,.field select { width:100%; background:var(--black); border:1px solid var(--green-dark); color:var(--green); font-family:var(--font-mono); font-size:0.78em; padding:9px 10px; outline:none; resize:none; }
        .field input:focus,.field textarea:focus,.field select:focus { border-color:var(--green-dim); }
        .film-fields,.music-fields { display:none; }
        #up-progress { display:none; margin-bottom:10px; }
        .prog-bar { background:var(--green-dark); height:3px; }
        .prog-fill { height:100%; background:var(--green); width:0%; transition:width 0.3s; box-shadow:0 0 5px var(--green); }
        .prog-txt { font-size:0.62em; color:var(--green-dim); margin-top:3px; }
        .btn-pub { width:100%; padding:14px; background:var(--green); color:var(--black); border:none; font-family:var(--font-display); font-size:0.72em; font-weight:900; letter-spacing:3px; cursor:pointer; transition:0.2s; }
        .btn-pub:hover { box-shadow:0 0 24px var(--green); }
        .btn-pub:disabled { opacity:0.35; cursor:not-allowed; box-shadow:none; }

        /* â”€â”€ ZAP MODAL â”€â”€ */
        #zap-modal { position:fixed; inset:0; z-index:500; background:rgba(0,0,0,0.88); display:none; align-items:flex-end; }
        #zap-modal.open { display:flex; }
        .zap-sheet { width:100%; background:rgba(10,8,0,0.98); border-top:1px solid var(--yellow); padding:20px 16px 32px; animation:slideUp 0.3s ease; }
        .zap-title { font-family:var(--font-display); font-size:0.78em; letter-spacing:3px; color:var(--yellow); margin-bottom:16px; text-align:center; }
        .sats-row { display:flex; gap:7px; flex-wrap:wrap; margin-bottom:12px; }
        .sat-btn { flex:1; min-width:52px; padding:10px 3px; text-align:center; border:1px solid rgba(255,204,0,0.22); background:none; color:rgba(255,204,0,0.55); font-family:var(--font-mono); font-size:0.76em; cursor:pointer; transition:0.2s; }
        .sat-btn:hover,.sat-btn.sel { border-color:var(--yellow); color:var(--yellow); background:rgba(255,204,0,0.09); }
        .zap-input { width:100%; background:var(--black); border:1px solid rgba(255,204,0,0.22); color:var(--yellow); font-family:var(--font-mono); font-size:0.83em; padding:9px 11px; outline:none; margin-bottom:9px; }
        .zap-input:focus { border-color:var(--yellow); }
        .btn-zap { width:100%; padding:13px; background:var(--yellow); color:var(--black); border:none; font-family:var(--font-display); font-size:0.77em; font-weight:900; letter-spacing:3px; cursor:pointer; transition:0.2s; }
        .btn-zap:hover { box-shadow:0 0 22px var(--yellow); }
        .zap-cancel { width:100%; padding:9px; background:none; border:none; color:rgba(255,204,0,0.35); font-family:var(--font-mono); font-size:0.7em; cursor:pointer; margin-top:7px; letter-spacing:2px; }

        /* â”€â”€ PLACEHOLDER / EMPTY â”€â”€ */
        .slide-placeholder { width:100%; height:100vh; scroll-snap-align:start; display:flex; align-items:center; justify-content:center; }
        .ph-text { font-size:0.72em; color:var(--green-dim); letter-spacing:3px; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:0.25} 50%{opacity:1} }

        /* â”€â”€ TOAST â”€â”€ */
        #toast { position:fixed; top:74px; left:50%; transform:translateX(-50%) translateY(-8px); background:rgba(0,255,65,0.12); color:var(--green); border:1px solid var(--green-dim); padding:7px 16px; font-family:var(--font-display); font-size:0.62em; font-weight:700; letter-spacing:2px; opacity:0; transition:0.28s; z-index:999; white-space:nowrap; backdrop-filter:blur(8px); }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div id="topbar">
    <div class="logo">M4TR1X</div>
    <div id="topbar-right">
        <button class="top-btn" onclick="toast('EXPLORE â€” COMING SOON')">ğŸ”</button>
        <div id="user-avatar-top">ğŸ‘¤</div>
    </div>
</div>

<div id="section-tabs">
    <button class="sec-tab active" onclick="switchSec('signal')">ğŸ“¡ SIGNAL</button>
    <button class="sec-tab film-tab" onclick="switchSec('film')">ğŸ¬ FILM</button>
    <button class="sec-tab music-tab" onclick="switchSec('music')">ğŸµ MUSIC</button>
</div>

<div class="section-banner" id="banner-film">
    <span class="banner-icon">ğŸ¬</span>
    <div class="banner-text"><strong>INDIE FILM CHANNEL</strong>Solo contenuti autoprodotti Â· Registi emergenti Â· No pirateria</div>
</div>
<div class="section-banner" id="banner-music">
    <span class="banner-icon">ğŸµ</span>
    <div class="banner-text"><strong>UNDERGROUND MUSIC</strong>Solo artisti emergenti Â· Produzioni indipendenti Â· No materiale altrui</div>
</div>

<button id="mute-btn" onclick="toggleMute()">ğŸ”‡</button>

<div id="feed-wrap">
    <div class="section-feed active" id="feed-signal"><div class="slide-placeholder"><div class="ph-text">[ CONNECTING TO RELAYS... ]</div></div></div>
    <div class="section-feed" id="feed-film"><div class="slide-placeholder"><div class="ph-text">[ LOADING INDIE FILMS... ]</div></div></div>
    <div class="section-feed" id="feed-music"><div class="slide-placeholder"><div class="ph-text">[ LOADING UNDERGROUND MUSIC... ]</div></div></div>
</div>

<div id="bottom-nav">
    <button class="bnav active" id="bnav-signal" onclick="switchSec('signal')"><span class="bicon">ğŸ“¡</span>SIGNAL</button>
    <button class="bnav film-nav" id="bnav-film" onclick="switchSec('film')"><span class="bicon">ğŸ¬</span>FILM</button>
    <button class="bnav post-nav" onclick="openUpload()"><span class="bicon">ï¼‹</span>POST</button>
    <button class="bnav music-nav" id="bnav-music" onclick="switchSec('music')"><span class="bicon">ğŸµ</span>MUSIC</button>
    <button class="bnav" onclick="toast('PROFILE â€” COMING SOON')"><span class="bicon">ğŸ‘¤</span>PROFILE</button>
</div>

<!-- COMMENTS -->
<div id="comments-drawer">
    <div class="drawer-bar" onclick="closeComments()">
        <span class="drawer-bar-title">ğŸ’¬ REPLIES</span>
        <button class="drawer-bar-close">âœ•</button>
    </div>
    <div id="cmt-list"></div>
    <div id="cmt-input-bar">
        <input id="cmt-input" placeholder="BROADCAST REPLY..." spellcheck="false">
        <button id="cmt-send" onclick="postComment()">SEND</button>
    </div>
</div>

<!-- UPLOAD -->
<div id="upload-modal">
    <div class="upload-sheet">
        <div class="up-head">
            <span class="up-title" id="up-title">â¬† UPLOAD</span>
            <button class="up-close" onclick="closeUpload()">âœ•</button>
        </div>
        <div class="up-cats">
            <button class="up-cat signal sel" onclick="selCat(this,'signal')">ğŸ“¡ SIGNAL</button>
            <button class="up-cat film" onclick="selCat(this,'film')">ğŸ¬ FILM</button>
            <button class="up-cat music" onclick="selCat(this,'music')">ğŸµ MUSIC</button>
        </div>
        <div class="up-body">
            <div class="up-disc film" id="disc-film">
                ğŸ¬ <strong>INDIE FILM CHANNEL</strong><br>
                Carica solo contenuti di tua produzione. Cortometraggi, documentari, esperimenti visivi.
                Vietato il materiale altrui o protetto da copyright. Violazioni = ban permanente.
            </div>
            <div class="up-disc music" id="disc-music">
                ğŸµ <strong>UNDERGROUND MUSIC</strong><br>
                Solo musica originale tua. Demo, live session, videoclip autoprodotti.
                Nessuna cover senza licenza. Nessun materiale di altri artisti.
            </div>
            <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                <div class="dz-icon">ğŸ“¹</div>
                <strong style="font-size:0.82em">DROP VIDEO QUI</strong>
                <p>o clicca per selezionare Â· MP4, MOV Â· max 500MB</p>
            </div>
            <input type="file" id="file-input" accept="video/*">
            <div class="prev-wrap" id="prev-wrap">
                <video id="prev-video" controls muted></video>
            </div>
            <div class="field"><label>Titolo / Caption</label><input type="text" id="up-caption" placeholder="Cosa sta succedendo?"></div>
            <div class="film-fields" id="film-fields">
                <div class="field"><label>Titolo del film</label><input type="text" id="up-film-title" placeholder="Es. 'Notte Morta' â€” cortometraggio 2024"></div>
                <div class="field"><label>Genere</label><input type="text" id="up-film-genre" placeholder="documentario / noir / sperimentale..."></div>
                <div class="field"><label>Anno</label><input type="text" id="up-film-year" placeholder="2024"></div>
            </div>
            <div class="music-fields" id="music-fields">
                <div class="field"><label>Titolo del brano</label><input type="text" id="up-music-title" placeholder="Es. 'Signals' â€” singolo 2024"></div>
                <div class="field"><label>Genere / Stile</label><input type="text" id="up-music-genre" placeholder="rap / ambient / punk / jazz..."></div>
            </div>
            <div class="field"><label>Tag (separati da spazio)</label><input type="text" id="up-tags" placeholder="evidence underground indie"></div>
            <div class="field">
                <label>Server Blossom</label>
                <select id="up-server">
                    <option value="cdn.satellite.earth">cdn.satellite.earth (consigliato)</option>
                    <option value="blossom.band">blossom.band</option>
                    <option value="nostrcheck.me">nostrcheck.me</option>
                </select>
            </div>
            <div id="up-progress">
                <div class="prog-bar"><div class="prog-fill" id="prog-fill"></div></div>
                <div class="prog-txt" id="prog-txt">Preparando...</div>
            </div>
            <button class="btn-pub" id="btn-pub" onclick="doUpload()" disabled>PUBBLICA SU NOSTR</button>
        </div>
    </div>
</div>

<!-- ZAP -->
<div id="zap-modal">
    <div class="zap-sheet">
        <div class="zap-title">âš¡ SEND SATS</div>
        <div class="sats-row">
            <button class="sat-btn" onclick="setSats(21,this)">21</button>
            <button class="sat-btn" onclick="setSats(100,this)">100</button>
            <button class="sat-btn" onclick="setSats(500,this)">500</button>
            <button class="sat-btn" onclick="setSats(1000,this)">1K</button>
            <button class="sat-btn" onclick="setSats(5000,this)">5K</button>
        </div>
        <input class="zap-input" type="number" id="zap-amount" placeholder="Importo custom (sats)">
        <input class="zap-input" type="text" id="zap-comment" placeholder="Commento (opzionale)" style="margin-bottom:14px">
        <button class="btn-zap" onclick="sendZap()">âš¡ ZAP</button>
        <button class="zap-cancel" onclick="closeZap()">ANNULLA</button>
    </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€ AUTH GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
    const pk = sessionStorage.getItem('m4tr1x_pubkey');
    if(!pk){ window.location.href='auth.html'; }
    window._pk = pk;
    window._method = sessionStorage.getItem('m4tr1x_method');
    window._priv = sessionStorage.getItem('m4tr1x_privkey');
})();

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
    pubkey: window._pk,
    method: window._method,
    privkey: window._priv,
    muted: true,
    section: 'signal',
    loaded: {signal:false, film:false, music:false},
    cmtEventId: null,
    zapEventId: null,
    zapPubkey: null,
    file: null,
    uploadCat: 'signal'
};

const RELAYS = ['wss://relay.damus.io','wss://nos.lol','wss://relay.nostr.band','wss://nostr.wine','wss://relay.snort.social'];
const BLOSSOM = {'cdn.satellite.earth':'https://cdn.satellite.earth','blossom.band':'https://blossom.band','nostrcheck.me':'https://nostrcheck.me'};
const CAT_TAG = {signal:'m4tr1x-signal', film:'m4tr1x-film', music:'m4tr1x-music'};
const ws = {};
const seen = {signal:new Set(), film:new Set(), music:new Set()};
const profCache = {};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', ()=>{
    // Profile pic
    try{
        const p = JSON.parse(sessionStorage.getItem('m4tr1x_profile')||'{}');
        if(p.picture) document.getElementById('user-avatar-top').innerHTML=`<img src="${p.picture}" onerror="this.parentElement.textContent='ğŸ‘¤'">`;
    }catch(e){}

    connectRelays();

    // Drop zone
    const dz = document.getElementById('drop-zone');
    dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
    dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
    dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');handleFile(e.dataTransfer.files[0]);});
    document.getElementById('file-input').addEventListener('change',e=>handleFile(e.target.files[0]));
    document.getElementById('cmt-input').addEventListener('keydown',e=>{if(e.key==='Enter')postComment();});
});

function connectRelays(){
    RELAYS.forEach(url=>{
        try{
            const w = new WebSocket(url);
            ws[url] = {w, ok:false};
            w.onopen = ()=>{
                ws[url].ok = true;
                if(!S.loaded.signal){ loadSec('signal'); S.loaded.signal=true; }
            };
            w.onclose = w.onerror = ()=>{ ws[url].ok=false; };
        }catch(e){}
    });
    setTimeout(()=>{
        if(!S.loaded.signal){
            document.getElementById('feed-signal').innerHTML='<div class="slide-placeholder"><div class="ph-text" style="color:var(--green-dark)">[ NO RELAY â€” BE THE FIRST TO UPLOAD ]</div></div>';
        }
    },9000);
}

// â”€â”€ SECTION SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchSec(name){
    S.section = name;
    document.querySelectorAll('.sec-tab').forEach((t,i)=>{ t.classList.toggle('active',['signal','film','music'][i]===name); });
    document.querySelectorAll('.section-feed').forEach(f=>f.classList.remove('active'));
    document.getElementById('feed-'+name).classList.add('active');
    document.querySelectorAll('.section-banner').forEach(b=>b.classList.remove('show'));
    if(name!=='signal') document.getElementById('banner-'+name).classList.add('show');
    document.querySelectorAll('.bnav').forEach(b=>b.classList.remove('active'));
    const bmap={signal:'bnav-signal',film:'bnav-film',music:'bnav-music'};
    if(bmap[name]) document.getElementById(bmap[name]).classList.add('active');
    if(!S.loaded[name]){ loadSec(name); S.loaded[name]=true; }
    setTimeout(()=>autoPlay(name),200);
}

// â”€â”€ LOAD SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSec(sec){
    const c = document.getElementById('feed-'+sec);
    c.innerHTML='<div class="slide-placeholder"><div class="ph-text">[ SCANNING... ]</div></div>';

    Object.entries(ws).forEach(([url,r])=>{
        if(!r.ok) return;
        const sid = 'sec_'+sec+'_'+rnd();
        const filter = sec==='signal'
            ? {kinds:[1063], limit:25}
            : {kinds:[1063], '#t':['m4tr1x-'+sec], limit:20};
        r.w.send(JSON.stringify(['REQ',sid,filter]));
        r.w.addEventListener('message',e=>{
            try{
                const d=JSON.parse(e.data);
                if(d[0]!=='EVENT') return;
                const ev=d[2];
                if(seen[sec].has(ev.id)) return;
                const uTag=ev.tags.find(t=>t[0]==='url');
                const mTag=ev.tags.find(t=>t[0]==='m');
                if(!uTag) return;
                const vurl=uTag[1];
                if(mTag&&!mTag[1].startsWith('video')&&!vurl.match(/\.(mp4|mov|webm)(\?|$)/i)) return;
                if(sec!=='signal'){
                    if(!ev.tags.some(t=>t[0]==='t'&&t[1]==='m4tr1x-'+sec)) return;
                }
                seen[sec].add(ev.id);
                const ph=c.querySelector('.slide-placeholder');
                if(ph) ph.remove();
                c.appendChild(mkSlide(ev,vurl,sec));
                loadProf(ev.pubkey).then(p=>updateSlide(ev.id,ev.pubkey,p));
            }catch(err){}
        });
    });
}

// â”€â”€ MAKE SLIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkSlide(ev,vurl,sec){
    const el=document.createElement('div');
    el.className='video-slide'; el.id='sl-'+ev.id;
    el.dataset.eid=ev.id; el.dataset.pk=ev.pubkey;

    const cap=esc(ev.content||'');
    const tags=ev.tags.filter(t=>t[0]==='t'&&!t[1].startsWith('m4tr1x-')).map(t=>'#'+t[1]).join(' ');
    const ft=ev.tags.find(t=>t[0]==='film-title')?.[1]||'';
    const mt=ev.tags.find(t=>t[0]==='music-title')?.[1]||'';
    const g=ev.tags.find(t=>t[0]==='genre')?.[1]||'';
    const mainTitle=ft||mt;

    el.innerHTML=`
        <video class="slide-video" preload="none" loop muted playsinline>
            <source src="${vurl}" type="video/mp4">
        </video>
        <div class="grad-top"></div>
        <div class="grad-bot"></div>
        <div class="play-flash" id="pf-${ev.id}"></div>
        <div class="slide-info">
            <div class="slide-author">
                <div class="slide-av" id="av-${ev.id}">ğŸ‘¤</div>
                <span class="slide-name" id="nm-${ev.id}">${shortenKey(ev.pubkey)}</span>
                <span class="slide-time">${ago(ev.created_at)}</span>
            </div>
            ${mainTitle?`<div class="slide-meta">${esc(mainTitle)}${g?`<span class="slide-genre">${esc(g)}</span>`:''}</div>`:''}
            ${cap?`<div class="slide-caption">${cap}</div>`:''}
            ${tags?`<div class="slide-tags">${tags}</div>`:''}
        </div>
        <div class="slide-actions">
            <div class="sact" onclick="viewProf('${ev.pubkey}')">
                <div class="sact-icon" id="sav-${ev.id}">ğŸ‘¤</div>
                <span class="sact-label">PROFILE</span>
            </div>
            <div class="sact zap-act" onclick="openZap('${ev.id}','${ev.pubkey}')">
                <div class="sact-icon">âš¡</div>
                <span class="sact-label">ZAP</span>
            </div>
            <div class="sact" onclick="openComments('${ev.id}')">
                <div class="sact-icon">ğŸ’¬</div>
                <span class="sact-label">REPLY</span>
            </div>
            <div class="sact" onclick="shareEv('${ev.id}')">
                <div class="sact-icon">ğŸ“¡</div>
                <span class="sact-label">RELAY</span>
            </div>
            <div class="sact" onclick="dlVid('${vurl}')">
                <div class="sact-icon">â¬‡</div>
                <span class="sact-label">SAVE</span>
            </div>
        </div>
        <div class="vid-prog"><div class="vid-prog-fill" id="vp-${ev.id}"></div></div>
    `;

    const vid=el.querySelector('video');
    vid.addEventListener('loadedmetadata',()=>{ if(vid.videoWidth>vid.videoHeight) vid.classList.add('landscape'); });
    vid.addEventListener('timeupdate',()=>{ if(vid.duration){ const f=document.getElementById('vp-'+ev.id); if(f) f.style.width=(vid.currentTime/vid.duration*100)+'%'; } });
    el.addEventListener('click',e=>{ if(e.target.closest('.slide-actions')||e.target.closest('.slide-author')) return; togglePlay(vid,ev.id); });

    const obs=new IntersectionObserver(entries=>{
        entries.forEach(en=>{
            if(en.isIntersecting){ vid.preload='auto'; vid.muted=S.muted; vid.play().catch(()=>{}); }
            else { vid.pause(); }
        });
    },{threshold:0.65});
    obs.observe(el);
    return el;
}

function togglePlay(vid,eid){
    const pf=document.getElementById('pf-'+eid);
    if(vid.paused){ vid.play(); flash(pf,'â–¶'); } else { vid.pause(); flash(pf,'â¸'); }
}
function flash(el,txt){ if(!el)return; el.textContent=txt; el.classList.add('on'); setTimeout(()=>el.classList.remove('on'),500); }
function autoPlay(sec){ document.getElementById('feed-'+sec).querySelectorAll('.slide-video').forEach(v=>{ const r=v.closest('.video-slide').getBoundingClientRect(); if(r.top>=0&&r.bottom<=window.innerHeight){ v.muted=S.muted; v.play().catch(()=>{}); } }); }
function toggleMute(){ S.muted=!S.muted; document.getElementById('mute-btn').textContent=S.muted?'ğŸ”‡':'ğŸ”Š'; document.querySelectorAll('.slide-video').forEach(v=>v.muted=S.muted); }

// â”€â”€ PROFILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSlide(eid,pk,p){
    const av=document.getElementById('av-'+eid), nm=document.getElementById('nm-'+eid), sav=document.getElementById('sav-'+eid);
    if(!av) return;
    const name=p?.name||p?.display_name||shortenKey(pk);
    if(nm) nm.textContent=name;
    if(p?.picture){ const img=`<img src="${p.picture}" onerror="this.parentElement.textContent='ğŸ‘¤'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`; av.innerHTML=img; if(sav)sav.innerHTML=img; }
}
function loadProf(pk){
    if(profCache[pk]) return Promise.resolve(profCache[pk]);
    return new Promise(res=>{
        let done=false;
        Object.values(ws).forEach(r=>{
            if(!r.ok)return;
            const sid='p_'+rnd();
            r.w.send(JSON.stringify(['REQ',sid,{kinds:[0],authors:[pk],limit:1}]));
            const h=e=>{try{const d=JSON.parse(e.data); if(d[0]==='EVENT'&&d[1]===sid){const p=JSON.parse(d[2].content); profCache[pk]=p; if(!done){done=true;res(p);} r.w.removeEventListener('message',h);}}catch(err){}};
            r.w.addEventListener('message',h);
        });
        setTimeout(()=>{if(!done)res(null);},4000);
    });
}
function viewProf(pk){ toast('PROFILE: '+shortenKey(pk)); }

// â”€â”€ COMMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openComments(eid){
    S.cmtEventId=eid;
    const list=document.getElementById('cmt-list');
    list.innerHTML='<div style="padding:14px;font-size:0.68em;color:var(--green-dim);letter-spacing:2px;animation:pulse 1.5s infinite">LOADING...</div>';
    document.getElementById('comments-drawer').classList.add('open');
    const seen2=new Set(); let found=false;
    Object.values(ws).forEach(r=>{
        if(!r.ok)return;
        const sid='c_'+rnd();
        r.w.send(JSON.stringify(['REQ',sid,{kinds:[1],'#e':[eid],limit:50}]));
        r.w.addEventListener('message',e=>{
            try{const d=JSON.parse(e.data); if(d[0]==='EVENT'&&d[1]===sid){const ev=d[2]; if(seen2.has(ev.id))return; seen2.add(ev.id); if(!found){found=true;list.innerHTML='';} const div=document.createElement('div'); div.className='cmt-item'; div.innerHTML=`<span class="cmt-author">${shortenKey(ev.pubkey)}</span>${esc(ev.content)}`; list.appendChild(div);}}catch(err){}
        });
    });
    setTimeout(()=>{ if(!found) list.innerHTML='<div style="padding:14px;font-size:0.68em;color:var(--green-dark)">No replies yet.</div>'; },4000);
}
function closeComments(){ document.getElementById('comments-drawer').classList.remove('open'); }
async function postComment(){
    if(!S.pubkey||!S.cmtEventId) return;
    const inp=document.getElementById('cmt-input');
    const txt=inp.value.trim(); if(!txt) return;
    try{
        const ev={kind:1,pubkey:S.pubkey,created_at:now(),tags:[['e',S.cmtEventId,'','reply']],content:txt};
        const signed=await signEv(ev); broadcast(signed); inp.value='';
        const div=document.createElement('div'); div.className='cmt-item'; div.innerHTML=`<span class="cmt-author">YOU</span>${esc(txt)}`;
        document.getElementById('cmt-list').appendChild(div);
        toast('REPLY SENT');
    }catch(e){ toast('ERROR: '+e.message); }
}

// â”€â”€ ZAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openZap(eid,pk){ if(!S.pubkey){toast('LOGIN FIRST');return;} S.zapEventId=eid; S.zapPubkey=pk; document.getElementById('zap-amount').value=''; document.getElementById('zap-comment').value=''; document.querySelectorAll('.sat-btn').forEach(b=>b.classList.remove('sel')); document.getElementById('zap-modal').classList.add('open'); }
function closeZap(){ document.getElementById('zap-modal').classList.remove('open'); }
function setSats(n,btn){ document.getElementById('zap-amount').value=n; document.querySelectorAll('.sat-btn').forEach(b=>b.classList.remove('sel')); btn.classList.add('sel'); }
async function sendZap(){
    const amount=parseInt(document.getElementById('zap-amount').value)||21;
    const comment=document.getElementById('zap-comment').value;
    if(!S.zapPubkey){closeZap();return;}
    try{
        const p=await loadProf(S.zapPubkey);
        const lud16=p?.lud16||p?.lightning;
        if(!lud16){toast('NO LIGHTNING ADDRESS');closeZap();return;}
        const zapReq={kind:9734,pubkey:S.pubkey,created_at:now(),tags:[['p',S.zapPubkey],['e',S.zapEventId],['amount',(amount*1000).toString()],['relays',...RELAYS]],content:comment};
        const signed=await signEv(zapReq);
        const encoded=encodeURIComponent(JSON.stringify(signed));
        const [u,d]=lud16.split('@');
        const ln=await(await fetch(`https://${d}/.well-known/lnurlp/${u}`)).json();
        if(!ln.callback) throw new Error('Invalid LNURL');
        const inv=await(await fetch(`${ln.callback}?amount=${amount*1000}&nostr=${encoded}&comment=${encodeURIComponent(comment)}`)).json();
        if(inv.pr){
            if(window.webln){await window.webln.enable();await window.webln.sendPayment(inv.pr);toast(`âš¡ ${amount} SATS SENT`);}
            else{navigator.clipboard.writeText(inv.pr);toast('INVOICE COPIATA');}
        }
    }catch(e){toast('ZAP ERROR: '+(e.message||'?'));}
    closeZap();
}

// â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openUpload(){ if(!S.pubkey){toast('LOGIN PRIMA');return;} document.getElementById('upload-modal').classList.add('open'); selCat(document.querySelector('.up-cat.signal'),'signal'); }
function closeUpload(){
    document.getElementById('upload-modal').classList.remove('open');
    document.getElementById('up-progress').style.display='none';
    document.getElementById('prog-fill').style.width='0%';
    S.file=null;
    document.getElementById('prev-wrap').style.display='none';
    document.getElementById('btn-pub').disabled=true;
    document.getElementById('drop-zone').innerHTML='<div class="dz-icon">ğŸ“¹</div><strong style="font-size:0.82em">DROP VIDEO QUI</strong><p>o clicca per selezionare Â· MP4, MOV Â· max 500MB</p>';
}
function selCat(btn,cat){
    document.querySelectorAll('.up-cat').forEach(b=>b.classList.remove('sel')); btn.classList.add('sel');
    S.uploadCat=cat;
    document.getElementById('up-title').textContent=cat==='film'?'ğŸ¬ UPLOAD INDIE FILM':cat==='music'?'ğŸµ UPLOAD MUSIC':'â¬† UPLOAD SIGNAL';
    document.querySelectorAll('.up-disc').forEach(d=>d.style.display='none');
    if(cat!=='signal') document.getElementById('disc-'+cat).style.display='block';
    document.getElementById('film-fields').style.display=cat==='film'?'block':'none';
    document.getElementById('music-fields').style.display=cat==='music'?'block':'none';
}
function handleFile(file){
    if(!file||!file.type.startsWith('video/')){toast('SOLO VIDEO');return;}
    S.file=file;
    document.getElementById('prev-video').src=URL.createObjectURL(file);
    document.getElementById('prev-wrap').style.display='block';
    document.getElementById('drop-zone').innerHTML=`<div class="dz-icon">âœ…</div><strong>${file.name}</strong><p>${(file.size/1024/1024).toFixed(1)} MB</p>`;
    document.getElementById('btn-pub').disabled=false;
}
async function doUpload(){
    if(!S.file) return;
    const btn=document.getElementById('btn-pub'); btn.disabled=true; btn.textContent='UPLOADING...';
    const prog=document.getElementById('up-progress'); prog.style.display='block';
    const fill=document.getElementById('prog-fill'); const ptxt=document.getElementById('prog-txt');
    try{
        const server=document.getElementById('up-server').value;
        ptxt.textContent='Upload in corso...'; fill.style.width='5%';
        const fd=new FormData(); fd.append('file',S.file);
        const xhr=new XMLHttpRequest();
        xhr.upload.onprogress=e=>{ if(e.lengthComputable) fill.style.width=(5+Math.round(e.loaded/e.total*70))+'%'; };
        const result=await new Promise((res,rej)=>{ xhr.onload=()=>{try{res(JSON.parse(xhr.responseText));}catch(e){rej(new Error('Risposta server non valida'));}}; xhr.onerror=()=>rej(new Error('Errore di rete')); xhr.open('POST',`https://${server}/upload`); xhr.send(fd); });
        fill.style.width='80%'; ptxt.textContent='Pubblicando su Nostr...';
        const vurl=result.url||result.nip94_event?.tags?.find(t=>t[0]==='url')?.[1];
        if(!vurl) throw new Error('Nessun URL dal server');
        const cap=document.getElementById('up-caption').value;
        const tagList=document.getElementById('up-tags').value.split(/\s+/).filter(Boolean).map(t=>['t',t.replace('#','')]);
        tagList.push(['t',CAT_TAG[S.uploadCat]]);
        if(S.uploadCat==='film'){
            const ft=document.getElementById('up-film-title').value; const fg=document.getElementById('up-film-genre').value; const fy=document.getElementById('up-film-year').value;
            if(ft) tagList.push(['film-title',ft]); if(fg) tagList.push(['genre',fg]); if(fy) tagList.push(['year',fy]);
        }
        if(S.uploadCat==='music'){
            const mt=document.getElementById('up-music-title').value; const mg=document.getElementById('up-music-genre').value;
            if(mt) tagList.push(['music-title',mt]); if(mg) tagList.push(['genre',mg]);
        }
        const nostrEv={kind:1063,pubkey:S.pubkey,created_at:now(),tags:[['url',vurl],['m',S.file.type],['size',S.file.size.toString()],...(result.sha256?[['x',result.sha256]]:[]),['client','m4tr1x'],...tagList],content:cap};
        const signed=await signEv(nostrEv); broadcast(signed);
        fill.style.width='100%'; ptxt.textContent='PUBBLICATO âœ“';
        toast('BROADCAST COMPLETO');
        setTimeout(()=>{
            closeUpload();
            seen[S.uploadCat].add(signed.id);
            const c=document.getElementById('feed-'+S.uploadCat);
            const ph=c.querySelector('.slide-placeholder'); if(ph) ph.remove();
            c.insertBefore(mkSlide(signed,vurl,S.uploadCat),c.firstChild);
            switchSec(S.uploadCat);
        },1200);
    }catch(e){
        toast('ERRORE: '+e.message); ptxt.textContent='FALLITO'; fill.style.width='0%';
        btn.disabled=false; btn.textContent='PUBBLICA SU NOSTR';
    }
}

// â”€â”€ NOSTR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function signEv(event){
    if(S.method==='extension'&&window.nostr) return await window.nostr.signEvent(event);
    if(S.privkey&&window.NostrTools){ event.id=window.NostrTools.getEventHash(event); event.sig=window.NostrTools.signEvent(event,S.privkey); return event; }
    throw new Error('Nessun metodo di firma');
}
function broadcast(ev){ Object.values(ws).forEach(r=>{ if(r.ok&&r.w.readyState===1) r.w.send(JSON.stringify(['EVENT',ev])); }); }

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareEv(eid){ navigator.clipboard.writeText('https://snort.social/e/'+eid).then(()=>toast('LINK COPIATO')); }
function dlVid(url){ const a=document.createElement('a'); a.href=url; a.download='m4tr1x_'+Date.now()+'.mp4'; a.click(); toast('DOWNLOAD...'); }
function shortenKey(k){ return k?k.slice(0,6)+'â€¦'+k.slice(-4):'ANON'; }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
function ago(ts){ const s=Math.floor(Date.now()/1000)-ts; if(s<60) return s+'s'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; }
function now(){ return Math.floor(Date.now()/1000); }
function rnd(){ return Math.random().toString(36).slice(2,8); }
</script>
</body>
</html>
