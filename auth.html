<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4TR1X ‚Äî ACCESS PROTOCOL</title>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --green: #00ff41;
            --green-dim: #00aa2b;
            --green-dark: #003311;
            --green-glow: rgba(0,255,65,0.12);
            --black: #000;
            --surface: #050a05;
            --red: #ff2222;
            --yellow: #ffcc00;
            --font-mono: 'Share Tech Mono', monospace;
            --font-display: 'Orbitron', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            background: var(--black);
            color: var(--green);
            font-family: var(--font-mono);
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ‚îÄ CANVAS MATRIX RAIN ‚îÄ‚îÄ‚îÄ */
        #matrix-canvas {
            position: fixed; inset: 0;
            opacity: 0.18; z-index: 0; pointer-events: none;
        }

        /* scanlines */
        body::after {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(
                0deg, transparent, transparent 3px,
                rgba(0,255,65,0.02) 3px, rgba(0,255,65,0.02) 4px
            );
            pointer-events: none; z-index: 1;
        }

        /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
        #shell {
            position: relative; z-index: 2;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 440px 1fr;
            grid-template-rows: 1fr;
            align-items: center;
        }

        /* left decorative column */
        #left-deco {
            padding: 40px;
            display: flex; flex-direction: column; justify-content: center;
            gap: 30px; height: 100%;
            border-right: 1px solid var(--green-dark);
        }
        .deco-block { border-left: 2px solid var(--green-dark); padding-left: 15px; }
        .deco-label { font-size: 0.55em; color: var(--green-dark); letter-spacing: 3px; margin-bottom: 6px; text-transform: uppercase; }
        .deco-value { font-family: var(--font-display); font-size: 0.75em; color: var(--green-dim); letter-spacing: 1px; }
        .deco-value.live { color: var(--green); animation: flicker 3s infinite; }
        @keyframes flicker {
            0%,100%{opacity:1} 92%{opacity:1} 93%{opacity:0.4} 94%{opacity:1} 97%{opacity:0.7} 98%{opacity:1}
        }
        .deco-log {
            font-size: 0.6em; color: var(--green-dark); line-height: 2;
            border: 1px solid var(--green-dark); padding: 12px;
        }
        .deco-log span { display: block; }
        .deco-log .ok { color: var(--green-dim); }

        /* center panel */
        #center {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 30px 20px; height: 100%;
            gap: 0;
        }

        /* logo */
        .auth-logo {
            font-family: var(--font-display);
            font-size: 2.8em; font-weight: 900;
            color: var(--green);
            text-shadow: 0 0 30px var(--green), 0 0 60px rgba(0,255,65,0.3);
            letter-spacing: 8px; text-align: center;
            animation: glow-pulse 4s ease-in-out infinite;
            margin-bottom: 4px;
        }
        @keyframes glow-pulse {
            0%,100%{ text-shadow: 0 0 20px var(--green), 0 0 40px rgba(0,255,65,0.2); }
            50%{ text-shadow: 0 0 40px var(--green), 0 0 80px rgba(0,255,65,0.4), 0 0 120px rgba(0,255,65,0.1); }
        }
        .auth-tagline {
            font-size: 0.6em; color: var(--green-dim);
            letter-spacing: 5px; text-align: center; margin-bottom: 35px;
            text-transform: uppercase;
        }

        /* card */
        .auth-card {
            width: 100%; max-width: 400px;
            background: rgba(5,10,5,0.95);
            border: 1px solid var(--green-dim);
            box-shadow: 0 0 40px rgba(0,255,65,0.1), inset 0 0 40px rgba(0,0,0,0.5);
        }

        .card-tabs {
            display: flex; border-bottom: 1px solid var(--green-dark);
        }
        .tab {
            flex: 1; padding: 14px 10px; text-align: center;
            font-family: var(--font-display); font-size: 0.6em;
            font-weight: 700; letter-spacing: 3px; cursor: pointer;
            color: var(--green-dark); background: none; border: none;
            border-bottom: 2px solid transparent; transition: 0.25s;
            text-transform: uppercase;
        }
        .tab:hover { color: var(--green-dim); }
        .tab.active {
            color: var(--green); border-bottom-color: var(--green);
            background: var(--green-glow);
            text-shadow: 0 0 8px var(--green);
        }

        .card-body { padding: 28px; }

        /* panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ STEP INDICATOR ‚îÄ‚îÄ‚îÄ */
        .steps-bar {
            display: flex; align-items: center; gap: 0; margin-bottom: 25px;
        }
        .step-dot {
            width: 28px; height: 28px; border-radius: 50%;
            border: 1px solid var(--green-dark);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-display); font-size: 0.55em;
            color: var(--green-dark); transition: 0.3s; flex-shrink: 0;
        }
        .step-dot.done { border-color: var(--green); color: var(--green); background: var(--green-glow); }
        .step-dot.current { border-color: var(--green); color: var(--green); box-shadow: 0 0 10px rgba(0,255,65,0.4); }
        .step-line {
            flex: 1; height: 1px; background: var(--green-dark); transition: 0.3s;
        }
        .step-line.done { background: var(--green); }

        /* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
        .field { margin-bottom: 16px; }
        .field-label {
            display: block; font-size: 0.62em; color: var(--green-dim);
            letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px;
        }
        .field-input, .field-textarea {
            width: 100%; background: var(--black);
            border: 1px solid var(--green-dark); border-bottom-color: var(--green-dim);
            color: var(--green); font-family: var(--font-mono); font-size: 0.82em;
            padding: 10px 12px; outline: none; transition: 0.2s;
            resize: none; caret-color: var(--green);
        }
        .field-input:focus, .field-textarea:focus {
            border-color: var(--green);
            box-shadow: 0 0 12px rgba(0,255,65,0.15);
        }
        .field-input::placeholder { color: var(--green-dark); }

        /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
        .btn-primary {
            width: 100%; padding: 14px;
            background: var(--green); color: var(--black);
            border: none; font-family: var(--font-display);
            font-size: 0.7em; font-weight: 900; letter-spacing: 3px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s;
            margin-top: 8px; position: relative; overflow: hidden;
        }
        .btn-primary::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: translateX(-100%); transition: 0.4s;
        }
        .btn-primary:hover::after { transform: translateX(100%); }
        .btn-primary:hover { box-shadow: 0 0 30px rgba(0,255,65,0.5); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-secondary {
            width: 100%; padding: 11px;
            background: none; color: var(--green-dim);
            border: 1px solid var(--green-dark); font-family: var(--font-mono);
            font-size: 0.72em; letter-spacing: 2px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s; margin-top: 8px;
        }
        .btn-secondary:hover { border-color: var(--green-dim); color: var(--green); }

        .btn-ext {
            width: 100%; padding: 14px;
            background: var(--green-dark); color: var(--green);
            border: 1px solid var(--green-dim); font-family: var(--font-display);
            font-size: 0.68em; font-weight: 700; letter-spacing: 2px;
            cursor: pointer; text-transform: uppercase; transition: 0.2s; margin-top: 8px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-ext:hover { background: var(--green-glow); border-color: var(--green); box-shadow: 0 0 15px rgba(0,255,65,0.2); }

        /* ‚îÄ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ‚îÄ */
        .or-divider {
            display: flex; align-items: center; gap: 12px;
            margin: 18px 0; font-size: 0.6em; color: var(--green-dark); letter-spacing: 3px;
        }
        .or-divider::before, .or-divider::after {
            content: ''; flex: 1; height: 1px; background: var(--green-dark);
        }

        /* ‚îÄ‚îÄ‚îÄ KEY BOX ‚îÄ‚îÄ‚îÄ */
        .key-box {
            background: var(--black); border: 1px solid var(--green-dark);
            border-left: 3px solid var(--green); padding: 12px 14px;
            margin: 12px 0; position: relative;
        }
        .key-box-label { font-size: 0.55em; color: var(--green-dim); letter-spacing: 2px; margin-bottom: 6px; }
        .key-box-value {
            font-size: 0.68em; color: var(--green); word-break: break-all;
            line-height: 1.5; font-family: var(--font-mono);
        }
        .copy-btn {
            position: absolute; top: 8px; right: 8px;
            background: none; border: 1px solid var(--green-dark);
            color: var(--green-dim); font-family: var(--font-mono);
            font-size: 0.6em; padding: 3px 8px; cursor: pointer; transition: 0.2s;
        }
        .copy-btn:hover { border-color: var(--green); color: var(--green); }

        .warning-box {
            background: rgba(255,34,34,0.07); border: 1px solid rgba(255,34,34,0.3);
            border-left: 3px solid var(--red); padding: 10px 14px;
            margin: 12px 0; font-size: 0.65em; color: #ff6666; line-height: 1.6;
        }

        .info-box {
            background: var(--green-glow); border: 1px solid var(--green-dark);
            padding: 10px 14px; margin: 12px 0;
            font-size: 0.65em; color: var(--green-dim); line-height: 1.7;
        }
        .info-box strong { color: var(--green); }

        /* ‚îÄ‚îÄ‚îÄ NSEC IMPORT ‚îÄ‚îÄ‚îÄ */
        .nsec-input-wrapper { position: relative; }
        .nsec-toggle {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--green-dim); cursor: pointer;
            font-size: 0.9em;
        }

        /* ‚îÄ‚îÄ‚îÄ SUCCESS SCREEN ‚îÄ‚îÄ‚îÄ */
        #success-screen {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: var(--black); flex-direction: column;
            align-items: center; justify-content: center; gap: 20px;
        }
        #success-screen.show { display: flex; }
        .success-logo {
            font-family: var(--font-display); font-size: 3em; font-weight: 900;
            color: var(--green); text-shadow: 0 0 40px var(--green);
            animation: glow-pulse 2s infinite;
        }
        .success-msg {
            font-size: 0.8em; color: var(--green-dim); letter-spacing: 3px;
            text-align: center; line-height: 2;
        }
        .progress-line {
            width: 300px; height: 2px; background: var(--green-dark); position: relative; overflow: hidden;
        }
        .progress-line::after {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%; background: var(--green);
            box-shadow: 0 0 10px var(--green);
            animation: progress-sweep 2s ease forwards;
        }
        @keyframes progress-sweep { from{left:-100%} to{left:100%} }

        /* ‚îÄ‚îÄ‚îÄ RIGHT DECO ‚îÄ‚îÄ‚îÄ */
        #right-deco {
            padding: 40px;
            display: flex; flex-direction: column; justify-content: center;
            gap: 30px; height: 100%;
            border-left: 1px solid var(--green-dark);
        }

        .protocol-list { list-style: none; }
        .protocol-list li {
            font-size: 0.6em; color: var(--green-dark); padding: 6px 0;
            border-bottom: 1px solid rgba(0,255,65,0.05);
            display: flex; gap: 8px; align-items: flex-start;
        }
        .protocol-list li::before { content: '//'; color: var(--green-dark); flex-shrink: 0; }
        .protocol-list li.active-item::before { color: var(--green-dim); }
        .protocol-list li.active-item { color: var(--green-dim); }

        /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
        #toast {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--green); color: var(--black);
            padding: 9px 20px; font-family: var(--font-display);
            font-size: 0.65em; font-weight: 700; letter-spacing: 2px;
            opacity: 0; transition: 0.3s; z-index: 999;
            box-shadow: 0 0 20px var(--green);
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 900px) {
            #shell { grid-template-columns: 1fr; }
            #left-deco, #right-deco { display: none; }
            body { overflow-y: auto; }
            html, body { height: auto; }
        }

        /* step transitions */
        .step-content { animation: stepIn 0.3s ease; }
        @keyframes stepIn { from{opacity:0;transform:translateX(10px)} to{opacity:1;transform:translateX(0)} }

        /* QR placeholder */
        .qr-placeholder {
            width: 120px; height: 120px; margin: 15px auto;
            border: 1px solid var(--green-dark); background: var(--black);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6em; color: var(--green-dark); text-align: center;
            line-height: 1.4;
        }

        .checkbox-field {
            display: flex; align-items: center; gap: 10px;
            margin: 14px 0; cursor: pointer;
        }
        .checkbox-field input[type=checkbox] { accent-color: var(--green); width: 16px; height: 16px; cursor: pointer; }
        .checkbox-field label { font-size: 0.68em; color: var(--green-dim); cursor: pointer; line-height: 1.4; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<!-- SUCCESS OVERLAY -->
<div id="success-screen">
    <div class="success-logo">M4TR1X</div>
    <div class="success-msg">IDENTITY VERIFIED<br>SIGNAL ESTABLISHED</div>
    <div class="progress-line"></div>
    <div style="font-size:0.65em;color:var(--green-dark);letter-spacing:2px">LOADING BROADCAST NETWORK...</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<div id="shell">

    <!-- LEFT DECO -->
    <div id="left-deco">
        <div style="font-family:var(--font-display);font-size:0.7em;color:var(--green-dim);letter-spacing:3px;margin-bottom:10px">SYSTEM STATUS</div>
        <div class="deco-block">
            <div class="deco-label">PROTOCOL</div>
            <div class="deco-value live">NOSTR / NIP-07</div>
        </div>
        <div class="deco-block">
            <div class="deco-label">STORAGE</div>
            <div class="deco-value">BLOSSOM + IPFS</div>
        </div>
        <div class="deco-block">
            <div class="deco-label">ENCRYPTION</div>
            <div class="deco-value">CHACHA20-POLY1305</div>
        </div>
        <div class="deco-block">
            <div class="deco-label">IDENTITY</div>
            <div class="deco-value">SECP256K1 KEYPAIR</div>
        </div>
        <div class="deco-block">
            <div class="deco-label">NETWORK</div>
            <div class="deco-value live" id="relay-count">5 RELAYS ONLINE</div>
        </div>
        <div class="deco-log">
            <div class="deco-label" style="margin-bottom:8px">SYSTEM LOG</div>
            <span class="ok">[ OK ] kernel boot</span>
            <span class="ok">[ OK ] nostr module loaded</span>
            <span class="ok">[ OK ] relay pool init</span>
            <span id="ext-log" style="color:var(--green-dark)">[ .. ] scanning extensions</span>
            <span id="auth-log" style="color:var(--green-dark)">[ .. ] awaiting identity</span>
        </div>
    </div>

    <!-- CENTER -->
    <div id="center">
        <div class="auth-logo">M4TR1X</div>
        <div class="auth-tagline">Unfiltered Signal ¬∑ Evidence Protocol</div>

        <div class="auth-card">
            <div class="card-tabs">
                <button class="tab active" id="tab-signin" onclick="switchTab('signin')">SIGN IN</button>
                <button class="tab" id="tab-signup" onclick="switchTab('signup')">REGISTER</button>
            </div>
            <div class="card-body">

                <!-- ‚îÄ‚îÄ‚îÄ SIGN IN PANEL ‚îÄ‚îÄ‚îÄ -->
                <div class="panel active" id="panel-signin">
                    <div class="info-box">
                        M4TR1X uses <strong>Nostr</strong> for identity.<br>
                        No password. No email. Your key = your identity.
                    </div>

                    <button class="btn-ext" onclick="connectExtension()">
                        üîå CONNECT EXTENSION (ALBY / NOS2X)
                    </button>

                    <div class="or-divider">OR IMPORT KEY</div>

                    <div class="field">
                        <label class="field-label">Private Key (nsec or hex)</label>
                        <div class="nsec-input-wrapper">
                            <input class="field-input" type="password" id="nsec-import" placeholder="nsec1... or 64-char hex" spellcheck="false" autocomplete="off">
                            <button class="nsec-toggle" onclick="toggleNsecVisibility()" title="Show/hide key">üëÅ</button>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="importKey()">ACCESS NETWORK</button>
                    <button class="btn-secondary" onclick="switchTab('signup')">NEW NODE? REGISTER ‚Üí</button>
                </div>

                <!-- ‚îÄ‚îÄ‚îÄ SIGN UP PANEL ‚îÄ‚îÄ‚îÄ -->
                <div class="panel" id="panel-signup">

                    <!-- Step indicator -->
                    <div class="steps-bar" id="steps-bar">
                        <div class="step-dot current" id="sdot-1">1</div>
                        <div class="step-line" id="sline-1"></div>
                        <div class="step-dot" id="sdot-2">2</div>
                        <div class="step-line" id="sline-2"></div>
                        <div class="step-dot" id="sdot-3">3</div>
                    </div>

                    <!-- Step 1: Choose method -->
                    <div id="signup-step-1" class="step-content">
                        <div style="font-family:var(--font-display);font-size:0.6em;color:var(--green-dim);letter-spacing:2px;margin-bottom:16px">// CHOOSE IDENTITY METHOD</div>

                        <button class="btn-ext" onclick="connectExtension()">
                            üîå USE EXISTING EXTENSION (NIP-07)
                        </button>
                        <div style="font-size:0.6em;color:var(--green-dark);margin:6px 0 14px;text-align:center">Alby, nos2x, Nostore ‚Äî already have a Nostr key</div>

                        <div class="or-divider">OR</div>

                        <button class="btn-primary" onclick="goSignupStep(2)">GENERATE NEW KEYPAIR</button>
                        <div style="font-size:0.6em;color:var(--green-dark);margin-top:6px;text-align:center">New to Nostr? Start fresh.</div>
                    </div>

                    <!-- Step 2: Generate keys -->
                    <div id="signup-step-2" class="step-content" style="display:none">
                        <div style="font-family:var(--font-display);font-size:0.6em;color:var(--green-dim);letter-spacing:2px;margin-bottom:16px">// KEYPAIR GENERATION</div>

                        <div class="info-box">
                            Your keys are generated <strong>locally in your browser</strong>.<br>
                            Never sent to any server. <strong>You own your identity.</strong>
                        </div>

                        <button class="btn-primary" id="gen-btn" onclick="generateNewKeys()">‚ö° GENERATE KEYPAIR</button>

                        <div id="keys-output" style="display:none">
                            <div class="key-box" style="margin-top:14px">
                                <div class="key-box-label">PUBLIC KEY (NPUB) ‚Äî Share freely</div>
                                <div class="key-box-value" id="npub-out">‚Äî</div>
                                <button class="copy-btn" onclick="copyKey('npub-out')">COPY</button>
                            </div>
                            <div class="key-box" style="border-left-color:var(--red)">
                                <div class="key-box-label" style="color:var(--red)">PRIVATE KEY (NSEC) ‚Äî NEVER SHARE</div>
                                <div class="key-box-value" id="nsec-out" style="filter:blur(4px);cursor:pointer" onclick="revealNsec(this)">click to reveal</div>
                                <button class="copy-btn" onclick="copyKey('nsec-out')">COPY</button>
                            </div>
                            <div class="warning-box">
                                ‚ö† SAVE YOUR NSEC OFFLINE NOW.<br>
                                Write it on paper. It cannot be recovered.
                            </div>
                            <div class="checkbox-field">
                                <input type="checkbox" id="saved-check" onchange="checkSavedKey()">
                                <label for="saved-check">I have saved my private key in a safe place</label>
                            </div>
                            <button class="btn-primary" id="next-to-3" onclick="goSignupStep(3)" disabled>CONTINUE ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 3: Profile setup -->
                    <div id="signup-step-3" class="step-content" style="display:none">
                        <div style="font-family:var(--font-display);font-size:0.6em;color:var(--green-dim);letter-spacing:2px;margin-bottom:16px">// NODE PROFILE SETUP</div>

                        <div class="field">
                            <label class="field-label">Display Name *</label>
                            <input class="field-input" type="text" id="reg-name" placeholder="NODE_ALPHA" spellcheck="false" maxlength="50">
                        </div>
                        <div class="field">
                            <label class="field-label">Bio</label>
                            <textarea class="field-textarea" id="reg-bio" rows="2" placeholder="Boots on the ground. Witness protocol active." maxlength="200"></textarea>
                        </div>
                        <div class="field">
                            <label class="field-label">Lightning Address (for Zaps) ‚ö°</label>
                            <input class="field-input" type="text" id="reg-lud16" placeholder="you@getalby.com" spellcheck="false">
                        </div>
                        <div class="field">
                            <label class="field-label">Profile Picture URL (optional)</label>
                            <input class="field-input" type="text" id="reg-pic" placeholder="https://..." spellcheck="false">
                        </div>

                        <button class="btn-primary" onclick="publishAndEnter()">PUBLISH PROFILE + ENTER NETWORK</button>
                        <button class="btn-secondary" onclick="skipProfile()">SKIP ‚Äî ENTER ANONYMOUS</button>
                    </div>

                </div><!-- /panel-signup -->

            </div><!-- /card-body -->
        </div><!-- /auth-card -->

        <div style="margin-top:16px;font-size:0.55em;color:var(--green-dark);text-align:center;letter-spacing:2px;line-height:2">
            NO EMAIL. NO TRACKING. NO CENSORSHIP.<br>
            <span style="color:rgba(0,255,65,0.3)">PROTOCOL ALEX PRETTI ‚Äî FOR THE TRUTH</span>
        </div>
    </div>

    <!-- RIGHT DECO -->
    <div id="right-deco">
        <div style="font-family:var(--font-display);font-size:0.7em;color:var(--green-dim);letter-spacing:3px;margin-bottom:10px">ACTIVE MODULES</div>
        <ul class="protocol-list">
            <li class="active-item">NIP-07 browser extension auth</li>
            <li class="active-item">Secp256k1 keypair generation</li>
            <li class="active-item">NIP-94 video file events</li>
            <li class="active-item">Blossom decentralized storage</li>
            <li class="active-item">NIP-57 Lightning zaps</li>
            <li>NIP-05 identity verification</li>
            <li>E2E encrypted DMs (NIP-04)</li>
            <li>Tor / Onion relay routing</li>
        </ul>
        <div style="border:1px solid var(--green-dark);padding:14px;margin-top:10px">
            <div class="deco-label" style="margin-bottom:8px">GET A NOSTR EXTENSION</div>
            <div style="font-size:0.6em;color:var(--green-dim);line-height:2.2">
                <div>‚Üí <span style="color:var(--green)">Alby</span> ‚Äî getalby.com</div>
                <div>‚Üí <span style="color:var(--green)">nos2x</span> ‚Äî Chrome extension</div>
                <div>‚Üí <span style="color:var(--green)">Nostore</span> ‚Äî Safari/iOS</div>
                <div>‚Üí <span style="color:var(--green)">Amber</span> ‚Äî Android signer</div>
            </div>
        </div>
        <div id="right-ext-status" style="border:1px solid var(--green-dark);padding:10px;font-size:0.6em;color:var(--green-dark)">
            [ SCANNING FOR EXTENSION... ]
        </div>
    </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ MATRIX RAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    let cols, drops;
    const chars = '„Ç¢„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé01„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢'.split('');

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        cols = Math.floor(canvas.width / 16);
        drops = Array(cols).fill(1);
    }

    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#00ff41';
        ctx.font = '13px Share Tech Mono, monospace';
        drops.forEach((y, i) => {
            const char = chars[Math.floor(Math.random() * chars.length)];
            ctx.fillStyle = Math.random() > 0.97 ? '#ffffff' : '#00ff41';
            ctx.globalAlpha = Math.random() * 0.5 + 0.1;
            ctx.fillText(char, i * 16, y * 16);
            ctx.globalAlpha = 1;
            if (y * 16 > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        });
    }

    resize();
    window.addEventListener('resize', resize);
    setInterval(draw, 60);
})();

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const auth = {
    pubkey: null,
    privkey: null,
    profile: null,
    method: null // 'extension' | 'generated' | 'imported'
};

const RELAYS = [
    'wss://relay.damus.io',
    'wss://nos.lol',
    'wss://relay.nostr.band',
    'wss://nostr.wine',
    'wss://relay.snort.social'
];

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
    // Check if already logged in
    const stored = sessionStorage.getItem('m4tr1x_pubkey');
    if (stored) {
        enterNetwork(stored, false);
        return;
    }

    // Check extension
    setTimeout(() => {
        if (window.nostr) {
            document.getElementById('ext-log').textContent = '[ OK ] extension detected';
            document.getElementById('ext-log').style.color = 'var(--green-dim)';
            document.getElementById('right-ext-status').textContent = '‚úÖ NOSTR EXTENSION DETECTED';
            document.getElementById('right-ext-status').style.borderColor = 'var(--green-dim)';
            document.getElementById('right-ext-status').style.color = 'var(--green-dim)';
        } else {
            document.getElementById('ext-log').textContent = '[ -- ] no extension found';
            document.getElementById('right-ext-status').textContent = '‚ö† NO EXTENSION ‚Äî USE KEY IMPORT';
        }
    }, 800);
});

// ‚îÄ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ SIGN IN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function connectExtension() {
    if (!window.nostr) {
        showToast('NO EXTENSION FOUND ‚Äî INSTALL ALBY OR NOS2X');
        window.open('https://getalby.com', '_blank');
        return;
    }
    try {
        showToast('REQUESTING ACCESS...');
        const pubkey = await window.nostr.getPublicKey();
        auth.pubkey = pubkey;
        auth.method = 'extension';
        document.getElementById('auth-log').textContent = '[ OK ] identity verified';
        document.getElementById('auth-log').style.color = 'var(--green-dim)';
        sessionStorage.setItem('m4tr1x_pubkey', pubkey);
        sessionStorage.setItem('m4tr1x_method', 'extension');
        enterNetwork(pubkey, true);
    } catch(e) {
        showToast('ACCESS DENIED BY EXTENSION');
    }
}

function toggleNsecVisibility() {
    const input = document.getElementById('nsec-import');
    input.type = input.type === 'password' ? 'text' : 'password';
}

async function importKey() {
    const raw = document.getElementById('nsec-import').value.trim();
    if (!raw) { showToast('ENTER YOUR PRIVATE KEY'); return; }

    let privkey;
    try {
        const NT = getNT();
        if (raw.startsWith('nsec1')) {
            if (NT && NT.nip19) {
                const decoded = NT.nip19.decode(raw);
                privkey = typeof decoded.data === 'string' ? decoded.data : Array.from(decoded.data).map(b=>b.toString(16).padStart(2,'0')).join('');
            } else {
                showToast('NOSTR-TOOLS NOT LOADED ‚Äî USE HEX KEY');
                return;
            }
        } else if (/^[0-9a-fA-F]{64}$/.test(raw)) {
            privkey = raw.toLowerCase();
        } else {
            showToast('INVALID KEY FORMAT');
            return;
        }

        let pubkey;
        if (NT && NT.getPublicKey) {
            pubkey = NT.getPublicKey(privkey);
        } else {
            showToast('CANNOT DERIVE PUBKEY ‚Äî NOSTR-TOOLS NOT LOADED');
            return;
        }

        auth.privkey = privkey;
        auth.pubkey = pubkey;
        auth.method = 'imported';
        sessionStorage.setItem('m4tr1x_pubkey', pubkey);
        sessionStorage.setItem('m4tr1x_privkey', privkey);
        sessionStorage.setItem('m4tr1x_method', 'imported');
        enterNetwork(pubkey, true);
    } catch(e) {
        showToast('KEY ERROR: ' + e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ SIGN UP STEPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goSignupStep(n) {
    // Hide all steps
    [1,2,3].forEach(i => {
        const el = document.getElementById('signup-step-' + i);
        if (el) el.style.display = 'none';
    });
    // Update step indicator
    [1,2,3].forEach(i => {
        const dot = document.getElementById('sdot-' + i);
        if (!dot) return;
        dot.classList.remove('current','done');
        if (i < n) dot.classList.add('done');
        if (i === n) dot.classList.add('current');
    });
    [1,2].forEach(i => {
        const line = document.getElementById('sline-' + i);
        if (!line) return;
        line.classList.toggle('done', i < n);
    });
    // Show current step
    const current = document.getElementById('signup-step-' + n);
    if (current) { current.style.display = 'block'; current.classList.add('step-content'); }
}

function getNT() {
    return window.NostrTools || window.nostrTools || window.nostr_tools || null;
}

function generateNewKeys() {
    const btn = document.getElementById('gen-btn');
    btn.textContent = '[ GENERATING... ]';
    btn.disabled = true;

    setTimeout(() => {
        try {
            let privkey, pubkey, nsec, npub;
            const NT = getNT();

            if (NT && NT.generatePrivateKey) {
                // nostr-tools v1.x
                privkey = NT.generatePrivateKey();
                pubkey  = NT.getPublicKey(privkey);
                nsec    = NT.nip19 ? NT.nip19.nsecEncode(privkey) : privkey;
                npub    = NT.nip19 ? NT.nip19.npubEncode(pubkey)  : pubkey;
            } else if (NT && NT.generateSecretKey) {
                // nostr-tools v2.x
                const sk = NT.generateSecretKey();
                privkey  = Array.from(sk).map(b=>b.toString(16).padStart(2,'0')).join('');
                pubkey   = NT.getPublicKey(sk);
                nsec     = NT.nip19 ? NT.nip19.nsecEncode(sk)    : privkey;
                npub     = NT.nip19 ? NT.nip19.npubEncode(pubkey) : pubkey;
            } else {
// nostr-tools non disponibile
                                showToast('ERRORE: libreria nostr-tools non caricata. Ricarica la pagina.');
                                btn.textContent = '‚ö° GENERATE KEYPAIR';
                                btn.disabled = false;
                                return;
            }

            auth.privkey = privkey;
            auth.pubkey  = pubkey;
            auth.method  = 'generated';

            const nsecEl = document.getElementById('nsec-out');
            nsecEl.textContent  = nsec;
            nsecEl.dataset.full = nsec;
            document.getElementById('npub-out').textContent = npub;
            document.getElementById('keys-output').style.display = 'block';
            btn.textContent = '‚úÖ KEYPAIR GENERATED';

            sessionStorage.setItem('m4tr1x_pubkey',  pubkey);
            sessionStorage.setItem('m4tr1x_privkey', privkey);
            sessionStorage.setItem('m4tr1x_method',  'generated');

        } catch(e) {
            showToast('GENERATION ERROR: ' + e.message);
            btn.textContent = '‚ö° GENERATE KEYPAIR';
            btn.disabled = false;
        }
    }, 400);
}

function revealNsec(el) {
    el.style.filter = 'none';
    el.style.cursor = 'default';
    el.onclick = null;
}

function checkSavedKey() {
    const checked = document.getElementById('saved-check').checked;
    document.getElementById('next-to-3').disabled = !checked;
}

function copyKey(id) {
    const el = document.getElementById(id);
    const text = el.dataset.full || el.textContent;
    navigator.clipboard.writeText(text).then(() => showToast('COPIED TO CLIPBOARD'));
}

// ‚îÄ‚îÄ‚îÄ PROFILE PUBLISH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RELAY_WS = {};

function initRelaysForPublish() {
    RELAYS.forEach(url => {
        try {
            const ws = new WebSocket(url);
            RELAY_WS[url] = ws;
        } catch(e) {}
    });
}

async function publishAndEnter() {
    const name = document.getElementById('reg-name').value.trim();
    if (!name) { showToast('DISPLAY NAME REQUIRED'); return; }

    const profile = {
        name,
        display_name: name,
        about: document.getElementById('reg-bio').value.trim(),
        lud16: document.getElementById('reg-lud16').value.trim(),
        picture: document.getElementById('reg-pic').value.trim(),
        client: 'm4tr1x'
    };

    // Remove empty fields
    Object.keys(profile).forEach(k => { if (!profile[k]) delete profile[k]; });

    const event = {
        kind: 0,
        pubkey: auth.pubkey,
        created_at: Math.floor(Date.now() / 1000),
        tags: [],
        content: JSON.stringify(profile)
    };

    try {
        let signed;
        if (auth.method === 'extension') {
            signed = await window.nostr.signEvent(event);
        } else if (auth.privkey && window.NostrTools) {
            event.id = window.NostrTools.getEventHash(event);
            signed = window.NostrTools.signEvent(event, auth.privkey);
        } else {
            // Skip signing, just enter
            skipProfile();
            return;
        }

        // Broadcast to relays
        initRelaysForPublish();
        setTimeout(() => {
            Object.values(RELAY_WS).forEach(ws => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(['EVENT', signed]));
                }
            });
        }, 1000);

        sessionStorage.setItem('m4tr1x_profile', JSON.stringify(profile));
        showToast('PROFILE PUBLISHED TO NOSTR');
        setTimeout(() => enterNetwork(auth.pubkey, true), 800);
    } catch(e) {
        showToast('SIGN ERROR: ' + e.message);
    }
}

function skipProfile() {
    enterNetwork(auth.pubkey, true);
}

// ‚îÄ‚îÄ‚îÄ ENTER NETWORK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enterNetwork(pubkey, animate) {
    if (animate) {
        const s = document.getElementById('success-screen');
        s.classList.add('show');
        setTimeout(() => { window.location.href = './index.html'; }, 2200);
    } else {
        window.location.href = './index.html';
    }
}

// ‚îÄ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// Enter key on nsec input
document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.activeElement.id === 'nsec-import') importKey();
});
</script>
</body>
</html>
